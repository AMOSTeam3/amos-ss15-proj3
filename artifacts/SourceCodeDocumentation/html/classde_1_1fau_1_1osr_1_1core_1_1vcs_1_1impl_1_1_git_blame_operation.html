<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>ReqTracker: de.fau.osr.core.vcs.impl.GitBlameOperation Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Logo_documentation.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ReqTracker
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">-amos-ss15-proj3</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="classes.html"><span>Class&#160;Index</span></a></li>
      <li><a href="inherits.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="namespacede.html">de</a></li><li class="navelem"><a class="el" href="namespacede_1_1fau.html">fau</a></li><li class="navelem"><a class="el" href="namespacede_1_1fau_1_1osr.html">osr</a></li><li class="navelem"><a class="el" href="namespacede_1_1fau_1_1osr_1_1core.html">core</a></li><li class="navelem"><a class="el" href="namespacede_1_1fau_1_1osr_1_1core_1_1vcs.html">vcs</a></li><li class="navelem"><a class="el" href="namespacede_1_1fau_1_1osr_1_1core_1_1vcs_1_1impl.html">impl</a></li><li class="navelem"><a class="el" href="classde_1_1fau_1_1osr_1_1core_1_1vcs_1_1impl_1_1_git_blame_operation.html">GitBlameOperation</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="classde_1_1fau_1_1osr_1_1core_1_1vcs_1_1impl_1_1_git_blame_operation-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">de.fau.osr.core.vcs.impl.GitBlameOperation Class Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Similar to a git blame, this operation traverses history from the current HEAD and looks for modifications of the file at the given path.  
 <a href="classde_1_1fau_1_1osr_1_1core_1_1vcs_1_1impl_1_1_git_blame_operation.html#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a2e253d113e5e516b656ed4e6459a140a"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classde_1_1fau_1_1osr_1_1core_1_1vcs_1_1impl_1_1_git_blame_operation.html#a2e253d113e5e516b656ed4e6459a140a">GitBlameOperation</a> (<a class="el" href="classde_1_1fau_1_1osr_1_1core_1_1vcs_1_1interfaces_1_1_vcs_client.html">VcsClient</a> client, String path, BiFunction&lt; String, Integer,?extends Iterator&lt;?extends Object &gt;&gt; putBlame)</td></tr>
<tr class="separator:a2e253d113e5e516b656ed4e6459a140a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a885025c330f063b594c936cfb72c756d"><td class="memItemLeft" align="right" valign="top"><a class="el" href="classde_1_1fau_1_1osr_1_1core_1_1vcs_1_1_annotated_words.html">AnnotatedWords</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classde_1_1fau_1_1osr_1_1core_1_1vcs_1_1impl_1_1_git_blame_operation.html#a885025c330f063b594c936cfb72c756d">wordBlame</a> ()  throws GitAPIException, IOException </td></tr>
<tr class="separator:a885025c330f063b594c936cfb72c756d"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Similar to a git blame, this operation traverses history from the current HEAD and looks for modifications of the file at the given path. </p>
<p>It annotates each word with its source commit(s) (plural in case of ambiguousness), and all Objects returned by the given putBlame. In contrast with git blame it traverses not only one, but all possible paths through history, otherwise it would not be possible to permanently attach annotations to lines in commits. All annotations are either <a class="el" href="">ObjectId</a>s of commit objects or Objects returned by putBlame. </p><dl class="section author"><dt>Author</dt><dd>tobias </dd></dl>
</div><h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="a2e253d113e5e516b656ed4e6459a140a"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">de.fau.osr.core.vcs.impl.GitBlameOperation.GitBlameOperation </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classde_1_1fau_1_1osr_1_1core_1_1vcs_1_1interfaces_1_1_vcs_client.html">VcsClient</a>&#160;</td>
          <td class="paramname"><em>client</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">String&#160;</td>
          <td class="paramname"><em>path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">BiFunction&lt; String, Integer,?extends Iterator&lt;?extends Object &gt;&gt;&#160;</td>
          <td class="paramname"><em>putBlame</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">client</td><td></td></tr>
    <tr><td class="paramname">path</td><td>relative to the working copy </td></tr>
    <tr><td class="paramname">putBlame</td><td>Given a Commit id and a line number return an Annotation or null. </td></tr>
  </table>
  </dd>
</dl>
<dl class="exception"><dt>Exceptions</dt><dd>
  <table class="exception">
    <tr><td class="paramname">ClassCastException</td><td>if client is not a git client </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;                                                                                      {</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        this.client = (GitVcsClient) client;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;        this.repo = this.client.repo;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        <span class="comment">// convert path to unix style as expected by git</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        this.path = path.replaceAll(Matcher.quoteReplacement(<span class="stringliteral">&quot;\\&quot;</span>), <span class="stringliteral">&quot;/&quot;</span>);</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        this.putBlame = putBlame;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    }</div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a class="anchor" id="a885025c330f063b594c936cfb72c756d"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classde_1_1fau_1_1osr_1_1core_1_1vcs_1_1_annotated_words.html">AnnotatedWords</a> de.fau.osr.core.vcs.impl.GitBlameOperation.wordBlame </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> throws GitAPIException, IOException</td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="exception"><dt>Exceptions</dt><dd>
  <table class="exception">
    <tr><td class="paramname">GitAPIException</td><td></td></tr>
    <tr><td class="paramname">IOException</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>An instance of <a class="el" href="classde_1_1fau_1_1osr_1_1core_1_1vcs_1_1_annotated_words.html">AnnotatedWords</a> where every word from the committed contents of path is mapped to a deduplicated list of annotations. </dd></dl>
<div class="fragment"><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;                                                                          {</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="comment">         * at the moment, just look at the state at HEAD,</span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;<span class="comment">         * could be expanded in the future to</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<span class="comment">         *  a) parameterize the used commit</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="comment">         *  b) annotate the working copy instead </span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        ObjectId rootId = repo.resolve(<span class="stringliteral">&quot;HEAD&quot;</span>);</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        RevWalk walker = <span class="keyword">new</span> RevWalk(repo);</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        RevCommit rootCommit = walker.parseCommit(rootId);</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        Function&lt;ObjectId, byte[]&gt; readFunction = <span class="keywordtype">id</span> -&gt; {</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;            <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;                <span class="keywordflow">return</span> client.readBlob(<span class="keywordtype">id</span>);</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;            } <span class="keywordflow">catch</span> (IOException | GitAPIException e) {</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;                <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(e);</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;            }</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        };</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        FlatSource source;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;        <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;            ObjectId idAtHead = client.fileAtRev(walker, path, rootCommit);</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;            source = FlatSource.flatten(readFunction, idAtHead);</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;        } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;            <span class="keywordflow">throw</span> <span class="keyword">new</span> FileNotFoundException(path);</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        }</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;        @SuppressWarnings(<span class="stringliteral">&quot;unchecked&quot;</span>)</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        List&lt;Object&gt;[] currentBlame = new List[source.size()];</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        BlameItem topBlame = new BlameItem(rootCommit, new TreeMap&lt;&gt;(), path);</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;<span class="comment">         * initially, blame all lines on HEAD</span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;        <a class="code" href="_linkage_8js.html#ae4005834cbbcde3f7a4dfa0c0c7771f0">for</a>(<span class="keywordtype">int</span> i=0; i&lt;currentBlame.length; ++i) {</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;            currentBlame[i] = <span class="keyword">new</span> ArrayList&lt;&gt;();</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;            topBlame.words.put(i, i);</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        }</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;        workQueue.add(topBlame);</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        <span class="keywordflow">while</span>(!workQueue.isEmpty()) {</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;            BlameItem cur = workQueue.pollFirst();</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;            walker.parseCommit(cur.accused);</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;            ObjectId idAfter = client.fileAtRev(walker, cur.path, cur.accused);</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;            FlatSource after = FlatSource.flatten(readFunction, idAfter);</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;            </div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;            <span class="comment">/*</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="comment">             * pull in custom annotations from putBlame on all suspect lines</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="comment">             */</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;            <span class="keywordflow">if</span>(putBlame != null) {</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                String nameOfAccused = cur.accused.name();</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;                <span class="keywordflow">for</span>(Map.Entry&lt;Integer,Integer&gt; entry : cur.words.entrySet()) {</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                    Iterator&lt;? extends Object&gt; iterator = putBlame.apply(nameOfAccused, after.getLineByWord(entry.getKey()));</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;                    <span class="keywordflow">if</span>(iterator != null)</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                        Iterators.addAll(currentBlame[entry.getValue()], iterator);</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;                }</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;            }</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;            </div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;            RevCommit[] parents = cur.accused.getParents();</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;            <span class="comment">/*</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<span class="comment">             * found indicates if we found an unmodified copy in a parent,</span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="comment">             * if false, foundLines indicates which lines we were able to blame</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="comment">             * down in history</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="comment">             */</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;            <span class="keywordtype">boolean</span> found = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;            HashSet&lt;Integer&gt; foundLines = <span class="keyword">new</span> HashSet&lt;&gt;();</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;            <span class="keywordflow">for</span>(RevCommit parent : parents) {</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                walker.parseCommit(parent);</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                TreeWalk treeWalk = TreeWalk.forPath(repo, cur.path, cur.accused.getTree(), parent.getTree());</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                <span class="keywordflow">if</span>(treeWalk.idEqual(0, 1)) {</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                    <span class="comment">//the file has not changed between parent and accused</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                    </div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                    BlameItem nextItem = cur.shallowClone();</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                    nextItem.accused = parent;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                    push(nextItem);</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                    found = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;                    <span class="comment">//the file has changed</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                    </div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;                    ObjectId idBefore = client.fileAtRev(walker, cur.path, parent);</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;                    <span class="keywordflow">if</span>(idBefore == null) {</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;                        <span class="comment">/*</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="comment">                         * the file does not exist at the same path in parent and accused,</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="comment">                         * so go look for identical files</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="comment">                         * </span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="comment">                         * could be extended to look for similar files, but watch performance!</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;<span class="comment">                         */</span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                        treeWalk = <span class="keyword">new</span> TreeWalk(repo);</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                        treeWalk.setRecursive(<span class="keyword">true</span>);</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                        treeWalk.addTree(parent.getTree());</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;                        <span class="keywordflow">while</span>(treeWalk.next()) {</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;                            <span class="keywordflow">if</span>(treeWalk.getObjectId(0).equals(idAfter)) {</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                                String pathBefore = treeWalk.getPathString();</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;                                BlameItem nextItem = cur.shallowClone();</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                                nextItem.accused = parent;</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;                                nextItem.path = pathBefore;</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                                push(nextItem);</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;                                found = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;                                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;                            }</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;                        }</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;                        <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;                    }</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;                    <span class="comment">//the file is at the same location in parent</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;                    </div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                    byte[] byteBefore = client.readBlob(idBefore);</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                    EditList diff;</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                    FlatSource before = FlatSource.flatten(readFunction, idBefore);</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                    diff = diffAlgorithm.diff(RawTextComparator.DEFAULT, before, after);</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;                    <span class="comment">/*</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="comment">                     * The documentation does not state if diff is sorted,</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;<span class="comment">                     * just that the Edits do not overlap, but it is much</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="comment">                     * more convenient to have it sorted.</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="comment">                     */</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;                    <span class="keyword">final</span> Comparator&lt;Edit&gt; compEdit = (d1, d2) -&gt; d1.getBeginB() - d2.getBeginB();</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;                    diff.sort(compEdit);</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;                    </div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;                    BlameItem passedBlame = <span class="keyword">new</span> BlameItem(parent, <span class="keyword">new</span> TreeMap&lt;&gt;(), cur.path);</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;                    </div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;                    Iterator&lt;Map.Entry&lt;Integer, Integer&gt;&gt; entryIterator = cur.words.entrySet().iterator();</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;                    Iterator&lt;Edit&gt; editIterator = diff.iterator();</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;                    Map.Entry&lt;Integer, Integer&gt; curEntry = null;</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;                    <span class="keywordflow">if</span>(entryIterator.hasNext())</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;                        curEntry = entryIterator.next();</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;                    Edit curEdit = null;</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;                    <span class="keywordflow">if</span>(editIterator.hasNext())</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;                        curEdit = editIterator.next();</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                    <span class="keywordtype">int</span> offset = 0;</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;                    </div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                    <span class="comment">/*</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;<span class="comment">                     * traverse diff and words simultaneously</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;<span class="comment">                     */</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;                    <span class="keywordflow">while</span> (curEntry != null || entryIterator.hasNext()) {</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;                        <span class="keywordflow">if</span> (curEntry == null) {</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;                            curEntry = entryIterator.next();</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;                        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (curEdit == null &amp;&amp; editIterator.hasNext()) {</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;                            curEdit = editIterator.next();</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;                        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (curEdit != null &amp;&amp; curEdit.getBeginB() &lt;= curEntry.getKey()) {</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;                            <span class="keywordflow">if</span>(curEdit.getEndB() &gt; curEntry.getKey()) {</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;                                <span class="comment">/*</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="comment">                                 * curEntry was erased by curEdit</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;<span class="comment">                                 */</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;                                curEntry = null;</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;                            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;                                <span class="comment">/*</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="comment">                                 * curEdit introduced an offset before curEntry</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="comment">                                 */</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;                                offset += (curEdit.getEndA() - curEdit.getBeginA()) -</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;                                        (curEdit.getEndB() - curEdit.getBeginB());</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;                                curEdit = null;</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                            }</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;                        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;                            <span class="comment">/*</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;<span class="comment">                             * push curEntry with key corrected by offset</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;<span class="comment">                             */</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;                            foundLines.add(curEntry.getKey());</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;                            passedBlame.words.put(curEntry.getKey() + offset, curEntry.getValue());</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                            curEntry = null;</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;                        }</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;                    }</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;                    <span class="comment">/*</span></div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;<span class="comment">                     * push the lines we found in parent back to queue</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;<span class="comment">                     */</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;                    push(passedBlame);</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;                }</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;            }</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;            <span class="comment">/*</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;<span class="comment">             * If there is not identical parent file, we have to take</span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="comment">             * responsibility for all lines not found in some parent.</span></div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="comment">             */</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;            <span class="keywordflow">if</span>(!found){</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;                <span class="keywordflow">for</span>(Map.Entry&lt;Integer,Integer&gt; entry : cur.words.entrySet()) {</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;                    <span class="keywordflow">if</span>(!foundLines.contains(entry.getKey()))</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;                        currentBlame[entry.getValue()].add(cur.accused.getId());</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;                }</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;            }</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        }</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="comment">         * duplicate objects take up unneeded space, clean them up </span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;currentBlame.length; ++i)</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;            currentBlame[i] = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">new</span> HashSet&lt;&gt;(currentBlame[i]));</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;        </div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">new</span> AnnotatedWords(source, currentBlame);</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    }</div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
